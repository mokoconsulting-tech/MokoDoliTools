# Copyright (C) 2025 Moko Consulting <tech@mokoconsulting.tech>
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

# ============================================================================
# MokoCRM Module - Apache Configuration
# Security and access control for MokoCRM Dolibarr module
# ============================================================================

# Enable rewrite engine
RewriteEngine On

# Security Headers
<IfModule mod_headers.c>
    # Prevent clickjacking
    Header always append X-Frame-Options SAMEORIGIN
    
    # Prevent MIME type sniffing
    Header always set X-Content-Type-Options nosniff
    
    # Enable XSS protection
    Header always set X-XSS-Protection "1; mode=block"
    
    # Strict transport security (if HTTPS is enabled)
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Content Security Policy
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' cdn.jsdelivr.net cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' cdn.jsdelivr.net cdnjs.cloudflare.com; font-src 'self' cdnjs.cloudflare.com; img-src 'self' data:; connect-src 'self';"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Feature Policy / Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=(), payment=(), usb=(), magnetometer=(), accelerometer=(), gyroscope=()"
</IfModule>

# Protect sensitive files and directories
<FilesMatch "\.(sql|log|bak|backup|conf|config|ini|env)$">
    Require all denied
</FilesMatch>

# Protect class files from direct access
<Files "*.class.php">
    Require all denied
</Files>

# Protect library files from direct access
<FilesMatch "^(lib|core)/">
    <Files "*.php">
        Require all denied
    </Files>
</FilesMatch>

# Allow access to admin files only for authenticated users
<Directory "admin">
    # This will be handled by Dolibarr's authentication system
    # No additional restrictions needed here as admin/*.php files check permissions
</Directory>

# Protect Adminer access
<Directory "adminer">
    # Adminer access is controlled by PHP authentication in adminer.php
    # Additional IP restrictions can be added here if needed
    
    # Example: Restrict to specific IP ranges (uncomment and modify as needed)
    # Require ip 192.168.1
    # Require ip 10.0.0
    # Require ip 172.16
</Directory>

# Prevent access to version control and backup files
<FilesMatch "^\.">
    Require all denied
</FilesMatch>

<FilesMatch "\.(git|svn|hg|bzr)">
    Require all denied
</FilesMatch>

<FilesMatch "~$">
    Require all denied
</FilesMatch>

# Prevent access to common backup file extensions
<FilesMatch "\.(bak|backup|old|orig|save|swp|tmp)$">
    Require all denied
</FilesMatch>

# Compress CSS and JavaScript files for better performance
<IfModule mod_deflate.c>
    <FilesMatch "\.(css|js)$">
        SetOutputFilter DEFLATE
    </FilesMatch>
</IfModule>

# Set cache headers for static assets
<IfModule mod_expires.c>
    ExpiresActive On
    
    # CSS and JavaScript files
    ExpiresByType text/css "access plus 1 month"
    ExpiresByType application/javascript "access plus 1 month"
    ExpiresByType text/javascript "access plus 1 month"
    
    # Images
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType image/x-icon "access plus 1 year"
    
    # Fonts
    ExpiresByType application/font-woff "access plus 1 year"
    ExpiresByType application/font-woff2 "access plus 1 year"
    ExpiresByType application/vnd.ms-fontobject "access plus 1 year"
    ExpiresByType font/truetype "access plus 1 year"
    ExpiresByType font/opentype "access plus 1 year"
</IfModule>

# Set proper MIME types
<IfModule mod_mime.c>
    # Web fonts
    AddType application/font-woff .woff
    AddType application/font-woff2 .woff2
    AddType application/vnd.ms-fontobject .eot
    AddType font/truetype .ttf
    AddType font/opentype .otf
    
    # SVG
    AddType image/svg+xml .svg
    
    # JavaScript
    AddType application/javascript .js
    
    # JSON
    AddType application/json .json
</IfModule>

# Prevent server signature disclosure
ServerTokens Prod

# Prevent directory browsing
Options -Indexes

# Prevent access to PHP error logs
<Files "error_log">
    Require all denied
</Files>

<Files "php_errors.log">
    Require all denied
</Files>

# Block common attack patterns
<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Block SQL injection attempts
    RewriteCond %{QUERY_STRING} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} GLOBALS(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} _REQUEST(=|\[|\%[0-9A-Z]{0,2}) [OR]
    RewriteCond %{QUERY_STRING} ^.*(\[|\]|\(|\)|<|>|Ãª|"|;|\?|\*|=$).* [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*("|'|<|>|\||\\|\{|\}).*$ [NC,OR]
    RewriteCond %{QUERY_STRING} ^.*(\||\\).*$ [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*iframe.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (<|%3C)([^s]*s)+cript.*(>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*embed.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*object.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (\<|%3C).*applet.*(\>|%3E) [NC,OR]
    RewriteCond %{QUERY_STRING} (union|select|insert|drop|delete|update|cast|create|char|convert|alter|declare|exec|xp_cmdshell).*(from|into|where) [NC,OR]
    RewriteCond %{QUERY_STRING} eval\( [NC,OR]
    RewriteCond %{QUERY_STRING} base64_(en|de)code [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Block user agents that are known to be malicious
    RewriteCond %{HTTP_USER_AGENT} ^$ [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(-|\.|') [OR]
    RewriteCond %{HTTP_USER_AGENT} ^(.*)(<|>|%3C|%3E)(.*) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} ^(java|curl|wget|python) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (libwww-perl|libcurl|nutch|baiduspider|zmeu|nikto|nessus|morfeus|scanner) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (sqlmap|fimap|netsparker|acunetix|w3af) [NC]
    RewriteRule ^(.*)$ - [F,L]
    
    # Block requests with suspicious referers
    RewriteCond %{HTTP_REFERER} (\<|%3C).*script.*(\>|%3E) [NC,OR]
    RewriteCond %{HTTP_REFERER} (\<|%3C).*iframe.*(\>|%3E) [NC]
    RewriteRule ^(.*)$ - [F,L]
</IfModule>

# Log security events
<IfModule mod_log_config.c>
    # Define custom log format for security events
    LogFormat "%h %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\" \"%{X-Forwarded-For}i\"" mokocrm_security
    
    # Log blocked requests (this would need to be configured at the virtual host level)
    # CustomLog logs/mokocrm_security.log mokocrm_security env=blocked_request
</IfModule>

# Additional security for specific file types
<FilesMatch "\.(php|phtml|php3|php4|php5|phps)$">
    # Disable server-side includes
    Options -Includes
    
    # Disable script execution in uploads (if any)
    php_flag engine off
</FilesMatch>

# Re-enable PHP for legitimate PHP files
<FilesMatch "^(admin|adminer)/.*\.php$">
    php_flag engine on
</FilesMatch>

<Files "*.php">
    php_flag engine on
</Files>

# Protect against hotlinking (optional)
<IfModule mod_rewrite.c>
    # RewriteCond %{HTTP_REFERER} !^$
    # RewriteCond %{HTTP_REFERER} !^https?://(www\.)?yourdomain\.com [NC]
    # RewriteCond %{REQUEST_URI} \.(gif|jpg|jpeg|png|svg|css|js)$ [NC]
    # RewriteRule .* - [F,L]
</IfModule>

# Error pages (optional - customize as needed)
# ErrorDocument 403 /error/403.html
# ErrorDocument 404 /error/404.html
# ErrorDocument 500 /error/500.html

# End of MokoCRM .htaccess configuration
